@inherits LayoutComponentBase

@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment whe

@code{
    bool AllowEnterDirectlyInDevMode = false;
}

@if (BlazorSession.Current.Browser == null)
{
    BlazorSession.Current.SetTimeout(10, StateHasChanged);
    return;
}

@if (viewmode == "connecting")
{
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;padding:32px;">
        <div>
            Checking permission for @username ...
        </div>
    </div>

    return;
}

@if (viewmode == null)
{
    if (BlazorSession.Current.Browser.GetMemoryItem("LogonOK") as string != "OK")
    {
        if (AllowEnterDirectlyInDevMode && whe.EnvironmentName == "Development")
        {
            void LoginForDev()
            {
                BlazorSession.Current.Browser.SetMemoryItem("LogonOK", "OK");
            }

            <div style="display:flex;flex-direction:column;align-items:center;width:100%;padding:32px;">
                <h1>
                    Development
                </h1>
                <div>
                    In Development mode , you can use this app directly.
                </div>
                <div>
                    In Production mode , you must login into linux via ssh localhost:22
                </div>
                <button class="btn btn-primary" style="margin:32px;width:100px;" @onclick="LoginForDev">
                    OK
                </button>
            </div>
            return;
        }
        else
        {
            username = BlazorSession.Current.Browser.GetMemoryItem("console_username") as string;
            password = BlazorSession.Current.Browser.GetMemoryItem("console_password") as string;
            viewmode = "login";
        }
    }
}

@if (viewmode == "login")
{
    @*if (Environment.OSVersion.ToString().Contains("Windows"))
            {
                <div style="text-align:center;padding:32px;width:360px;margin:auto">
                    <h3>Windows + Production</h3>
                    <h3>Is Disabled for secure</h3>
                    <p>To test BlazorLinuxAdmin in windows</p>
                    <p>set </p>
                    <p>ASPNETCORE_ENVIRONMENT=Development</p>
                    <p>Example bat file : </p>
                    <pre style="text-align:left;width:280px;overflow:visible;display:inline-block;font-size:12px">
        SET ASPNETCORE_ENVIRONMENT=Development
        BlazorLinuxAdmin.exe</pre>
                </div>
                return;
            }*@

    <style>
        .label_1 {
            display: inline-block;
            width: 100px;
            text-align: right;
        }
    </style>
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;padding:32px;">
        <h1>BlazorLinuxAdmin</h1>
        <h3>OS : @Environment.OSVersion + @(Environment.Is64BitOperatingSystem?"64bit":"32bit")</h3>
        <EditForm Model="this">
            <span class="label_1">username:</span><InputText class="inp_username" @bind-Value="username" />
            <br />
            <span class="label_1">password:</span><InputText class="inp_password" type="password" @bind-Value="password" />
            <br />
            <span class="label_1"></span><button @onclick="DoLogin">Login</button>
        </EditForm>
        <br />
        <h4 style="color:red;text-align:center;">Warning<br />This application is no safe<br />Don't use it for public network</h4>
    </div>

    return;
}

@code{


    string viewmode = null;
    string username = "pi";
    string password = "raspberry";

    void DoLogin()
    {
        if (string.IsNullOrWhiteSpace(username))
        {
            BlazorSession.Current.Toast("Require username");
            BlazorSession.Current.EvalCode("document.querySelector('.inp_username').focus()");
            return;
        }
        if (string.IsNullOrWhiteSpace(password))
        {
            BlazorSession.Current.Toast("Require password");
            BlazorSession.Current.EvalCode("document.querySelector('.inp_password').focus()");
            return;
        }

        username = username.Trim();

        if (Environment.OSVersion.Platform == PlatformID.Unix)
        {
            DoLogin_Unix();
        }
        else if (Environment.OSVersion.Platform == PlatformID.Win32NT)
        {
            DoLogin_WinNT();
        }
        else
        {
            BlazorSession.Current.Alert("Error", "Not Support");
        }
    }

    void DoLogin_WinNT()
    {
        if (string.Equals(username, "Administrator", StringComparison.OrdinalIgnoreCase))
        {
            BlazorSession.Current.Alert("Error", "Not allow Administrator, try another user.");
            return;
        }

        using (var pc = new System.DirectoryServices.AccountManagement.PrincipalContext(System.DirectoryServices.AccountManagement.ContextType.Machine))
        {
            bool isok = pc.ValidateCredentials(username, password);
            if (!isok)
            {
                BlazorSession.Current.Alert("Error", "Invalid Credentials");
            }
            else
            {
                BlazorSession.Current.Browser.SetMemoryItem("LogonOK", "OK");
                viewmode = null;
            }
        }
    }

    void DoLogin_Unix()
    {

        Renci.SshNet.SshClient client = new Renci.SshNet.SshClient("localhost", username, password);

        viewmode = "connecting";

        BlazorSession ses = BlazorSession.Current;

        System.Threading.Thread t = new System.Threading.Thread(delegate ()
        {
            try
            {
                client.Connect();
            }
            catch (Exception x)
            {
                ses.InvokeInRenderThread(delegate
                {
                    BlazorSession.Current.Alert("Error", x.ToString());
                    viewmode = "login";
                    StateHasChanged();
                });
                return;
            }

            ses.InvokeInRenderThread(delegate
            {
                BlazorSession.Current.Browser.SetMemoryItem("console_username", username);
                BlazorSession.Current.Browser.SetMemoryItem("console_password", password);

                BlazorSession.Current.Browser.SetMemoryItem("LogonOK", "OK");
                viewmode = null;
                StateHasChanged();
            });

            try
            {

                client.Disconnect();
                client.Dispose();
            }
            catch
            {

            }

        });
        t.Start();
    }
}

<div class="sidebar">
    <NavMenu />
</div>

<div class="main">
    <div class="top-row px-4">
        <a href="https://docs.microsoft.com/aspnet/" target="_blank">About</a>
    </div>

    <div class="content px-4">
        @Body
    </div>
</div>
